<!DOCTYPE html>
<html lang="ko">
    <head>
        <title>Traviso.js - Example 1 - Basic World</title>
        <style>
            body {
                margin: 0;
                padding: 0;
                background-color: #000000;
                text-align: center;
            }
        </style>
        
        <script src="js/pixi/pixi.js"></script>
        <script src="js/isoengine/engine.js"></script>
        <script src="js/isoengine/moveengine.js"></script>
    </head>
    <body>
        <script>
                var pixiRoot = new PIXI.Application(800, 600, { backgroundColor : 0x6BACDE });
                document.body.appendChild(pixiRoot.view);

                var loader = new PIXI.loaders.Loader();
                
                // 텍스쳐를 임의로 만들어서 넣는다
                loader.add("tiles.json", "assets/mapdata/tiles.json",);
                loader.add("tiles.png", "assets/mapdata/tiles.png",);
                loader.add("objects.json", "assets/mapdata/objects.json",);
                loader.add("objects.png", "assets/mapdata/objects.png",);
                loader.add("walls.json", "assets/mapdata/walls.json",);
                loader.add("walls.png", "assets/mapdata/walls.png",);
                loader.add("map.json", "assets/mapdata/map.json",);

                // 캐릭터 애니메이션
                loader.add("assets/knight/atk_sw.json");
                loader.add("assets/knight/atk_nw.json");
                loader.add("assets/knight/idle_sw.json");
                loader.add("assets/knight/idle_nw.json");
                loader.add("assets/knight/walk_sw.json");
                loader.add("assets/knight/walk_nw.json");

                loader.add("shadow.png", "assets/shadow.png");
                loader.add("windowlight.png", "assets/windowlight.png");

                loader.load(function (loader, resources) { 
                 
                    const map2 = new Engine.IsoMap(17, 17, 32, 16); // 일단 하드코딩

                    const tiles = resources["tiles.json"].data
                    const objects = resources["objects.json"].data  
                    const walls = resources["walls.json"].data

                    const newMap = resources["map.json"].data
                    const tilebase = new PIXI.BaseTexture(resources["tiles.png"].data);
                    const objectbase = new PIXI.BaseTexture(resources["objects.png"].data);
                    const wallbase = new PIXI.BaseTexture(resources["walls.png"].data);

                    for (let i = 0; i < tiles.tilecount; ++i) {
                        const x = i % tiles.columns;
                        const y = Math.floor(i / tiles.columns);
                        const texture = new PIXI.Texture(tilebase, new PIXI.Rectangle (x * tiles.tilewidth, y * tiles.tileheight, tiles.tilewidth, tiles.tileheight));

                        const textureName = "tiles_" + i + ".png";
                        PIXI.Texture.addToCache(texture, textureName);
                        map2.addTile(i+1, textureName);
                    }

                    for (let i = 0; i < objects.tilecount; ++i) {
                        const x = i % objects.columns;
                        const y = Math.floor(i / objects.columns);
                        const texture = new PIXI.Texture(objectbase, new PIXI.Rectangle (x * objects.tilewidth, y * objects.tileheight, objects.tilewidth, objects.tileheight));
                        const textureName = "objects_" + i + ".png";
                        PIXI.Texture.addToCache(texture, textureName);
                        map2.addTile(i+273, textureName);
                    }

                    for (let i = 0; i < walls.tilecount; ++i) {
                        const x = i % walls.columns;
                        const y = Math.floor(i / walls.columns);
                        const texture = new PIXI.Texture(wallbase, new PIXI.Rectangle (x * walls.tilewidth, y * walls.tileheight, walls.tilewidth, walls.tileheight));
                        const textureName = "walls_" + i + ".png";
                        PIXI.Texture.addToCache(texture, textureName);
                        map2.addTile(i+257, textureName);
                    }

                    const groundLayer = newMap.layers[0];
                    for (let y = 0; y < groundLayer.height;++y) {
                        for (let x = 0; x < groundLayer.width;++x) {
                            const index =  y + (groundLayer.width - x -1)* groundLayer.width;
                            map2.setGroundTile(x, y, groundLayer.data[index]);
                        }
                    }

                    const objectsLayer = newMap.layers[1];
                    for (let y = 0; y < groundLayer.height;++y) {
                        for (let x = 0; x < groundLayer.width;++x) {
                            // -90도 돌려준다
                            const index =  y + (groundLayer.width - x -1)* groundLayer.width;
                            map2.setObjectTile(x, y, objectsLayer.data[index]);
                        }
                    }

                
                    map2.build();
                    pixiRoot.stage.addChild(map2);
                  
                    // 캐릭터를 추가한다
                    const character = new Engine.Character();
                    character.id = 1;
                    map2.addCharacter(character, 4, 4);

                    map2.onTileSelected = (x, y) => {
                        // 캐릭터를 옮긴다
                        map2.moveCharacter(character, x, y);
                    };

                    // 라이팅 이펙트를 추가해보자
                    {
                        var tilingSprite = new PIXI.Sprite(PIXI.Texture.fromFrame("windowlight.png"), 150, 164);
                        tilingSprite.alpha = 0.7;
                        tilingSprite.position.y -= 150;
                        tilingSprite.position.x += 164;
                        tilingSprite.blendMode = PIXI.BLEND_MODES.ADD;
                        

                        
            
                        const graphics = new PIXI.Graphics();
                        graphics.beginFill(0);
                        graphics.moveTo(150,0);
                        graphics.lineTo(150, 32);
                        graphics.lineTo(0,148);
                        graphics.lineTo(0, 64);
                        graphics.lineTo(150, 0);
                        graphics.endFill();

                        tilingSprite.mask = graphics;
                        tilingSprite.addChild(graphics);

                        map2.mapContainer.addChild(tilingSprite);
                        
                    }

                });

        </script>
    </body>
</html>
